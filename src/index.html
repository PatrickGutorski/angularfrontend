<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Angularfrontend</title>
  <base href="/">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <meta name="api-url" content="/api">
</head>
<body>
  <app-root></app-root>

  <!-- Load runtime env (optional override) -->
  <script src="/env.js"></script>

  <!-- Greeting button and result (added) -->
  <div id="greeting-widget" style="position:fixed; right:16px; bottom:16px; background:rgba(255,255,255,0.95); padding:12px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.08); font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; z-index:9999;">
    <button id="greetBtn" style="padding:8px 12px; border-radius:6px; border:1px solid #0b63ff; background:linear-gradient(#0b63ff,#0047d1); color:#fff; cursor:pointer;">Fetch Greeting</button>
    <div id="greetResult" style="margin-top:8px; max-width:320px; word-break:break-word; font-size:0.9rem; color:#111"></div>
  </div>

  <script>
    // Sends GET to the provided API and displays the result inside #greetResult
    (function () {
      // Build API base from runtime environment if available.
      // Priority:
      // 1) window.__env.apiUrl (if you include a runtime env script)
      // 2) <meta name="api-url" content="..."> tag in the document head
      // 3) fallback to the original IP
      function getApiBase() {
        try {
          if (window && window.__env && window.__env.apiUrl) {
            return window.__env.apiUrl;
          }
        } catch (e) {
          // ignore
        }

        var meta = document.querySelector('meta[name="api-url"]');
        if (meta && meta.getAttribute('content')) {
          return meta.getAttribute('content');
        }

        // Final fallback: original API host (keeps previous behavior)
        return '/api';
      }

      var apiBase = getApiBase();
      // Trim any trailing slash
      apiBase = apiBase.replace(/\/$/, '');
      var url = apiBase + '/greeting';

      const btn = document.getElementById('greetBtn');
      const out = document.getElementById('greetResult');

      function setLoading(loading) {
        if (!btn) return;
        btn.disabled = loading;
        btn.textContent = loading ? 'Fetchingâ€¦' : 'Fetch Greeting';
        btn.style.opacity = loading ? '0.7' : '1';
      }

      async function fetchGreeting() {
        if (!out) return;
        setLoading(true);
        out.textContent = '';
        try {
          const resp = await fetch(url, { method: 'GET', cache: 'no-store' });

          // Check response
          if (!resp.ok) {
            throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
          }

          // Try to parse JSON, otherwise show text
          const contentType = resp.headers.get('content-type') || '';
          let data;
          if (contentType.includes('application/json')) {
            data = await resp.json();
            // display a sensible property if available
            if (data && (data.greeting || data.message || data.data)) {
              out.textContent = data.greeting || data.message || JSON.stringify(data.data);
            } else {
              out.textContent = JSON.stringify(data);
            }
          } else {
            data = await resp.text();
            out.textContent = data;
          }
        } catch (err) {
          // Show user-friendly message
          out.textContent = 'Request failed: ' + (err && err.message ? err.message : String(err));
          console.error('Greeting fetch error:', err);
        } finally {
          setLoading(false);
        }
      }

      if (btn) {
        btn.addEventListener('click', fetchGreeting);
      }
    })();
  </script>
</body>
</html>
