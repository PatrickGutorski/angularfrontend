apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
  annotations:
    # 1. Tell Kubernetes to use the Azure Gateway
    kubernetes.io/ingress.class: azure/application-gateway

    appgw.ingress.kubernetes.io/backend-path-prefix: "/api/"

    # Fixes 404 errors for health probes on some setups
    # appgw.ingress.kubernetes.io/health-probe-status-codes: "200-404"

    # Use the real health endpoint and make sure it used /api/ prefix
    appgw.ingress.kubernetes.io/health-probe-path: "/api/actuator/health"
spec:
  rules:
    - http:
        paths:
          # RULE 1: API Traffic -> Backend
          # Note: Ensure 'name' matches your actual running service (kubectl get services)
          - path: /api/*
            pathType: ImplementationSpecific
            backend:
              service:
                name: testapp-backend-service
                port:
                  number: 80

          # RULE 2: All other traffic -> Frontend
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: testapp-frontend-service
                port:
                  number: 80
